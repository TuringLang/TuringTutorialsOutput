<!DOCTYPE html>
<HTML lang = "en">
<HEAD>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title>MiniTuring</title>
  

  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: { equationNumbers: { autoNumber: "AMS" } }
    });
  </script>

  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script>

  
<style>
pre.hljl {
    border: 1px solid #ccc;
    margin: 5px;
    padding: 5px;
    overflow-x: auto;
    color: rgb(68,68,68); background-color: rgb(251,251,251); }
pre.hljl > span.hljl-t { }
pre.hljl > span.hljl-w { }
pre.hljl > span.hljl-e { }
pre.hljl > span.hljl-eB { }
pre.hljl > span.hljl-o { }
pre.hljl > span.hljl-k { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kc { color: rgb(59,151,46); font-style: italic; }
pre.hljl > span.hljl-kd { color: rgb(214,102,97); font-style: italic; }
pre.hljl > span.hljl-kn { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kp { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kr { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-kt { color: rgb(148,91,176); font-weight: bold; }
pre.hljl > span.hljl-n { }
pre.hljl > span.hljl-na { }
pre.hljl > span.hljl-nb { }
pre.hljl > span.hljl-nbp { }
pre.hljl > span.hljl-nc { }
pre.hljl > span.hljl-ncB { }
pre.hljl > span.hljl-nd { color: rgb(214,102,97); }
pre.hljl > span.hljl-ne { }
pre.hljl > span.hljl-neB { }
pre.hljl > span.hljl-nf { color: rgb(66,102,213); }
pre.hljl > span.hljl-nfm { color: rgb(66,102,213); }
pre.hljl > span.hljl-np { }
pre.hljl > span.hljl-nl { }
pre.hljl > span.hljl-nn { }
pre.hljl > span.hljl-no { }
pre.hljl > span.hljl-nt { }
pre.hljl > span.hljl-nv { }
pre.hljl > span.hljl-nvc { }
pre.hljl > span.hljl-nvg { }
pre.hljl > span.hljl-nvi { }
pre.hljl > span.hljl-nvm { }
pre.hljl > span.hljl-l { }
pre.hljl > span.hljl-ld { color: rgb(148,91,176); font-style: italic; }
pre.hljl > span.hljl-s { color: rgb(201,61,57); }
pre.hljl > span.hljl-sa { color: rgb(201,61,57); }
pre.hljl > span.hljl-sb { color: rgb(201,61,57); }
pre.hljl > span.hljl-sc { color: rgb(201,61,57); }
pre.hljl > span.hljl-sd { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdB { color: rgb(201,61,57); }
pre.hljl > span.hljl-sdC { color: rgb(201,61,57); }
pre.hljl > span.hljl-se { color: rgb(59,151,46); }
pre.hljl > span.hljl-sh { color: rgb(201,61,57); }
pre.hljl > span.hljl-si { }
pre.hljl > span.hljl-so { color: rgb(201,61,57); }
pre.hljl > span.hljl-sr { color: rgb(201,61,57); }
pre.hljl > span.hljl-ss { color: rgb(201,61,57); }
pre.hljl > span.hljl-ssB { color: rgb(201,61,57); }
pre.hljl > span.hljl-nB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nbB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nfB { color: rgb(59,151,46); }
pre.hljl > span.hljl-nh { color: rgb(59,151,46); }
pre.hljl > span.hljl-ni { color: rgb(59,151,46); }
pre.hljl > span.hljl-nil { color: rgb(59,151,46); }
pre.hljl > span.hljl-noB { color: rgb(59,151,46); }
pre.hljl > span.hljl-oB { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-ow { color: rgb(102,102,102); font-weight: bold; }
pre.hljl > span.hljl-p { }
pre.hljl > span.hljl-c { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-ch { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cm { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cp { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cpB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-cs { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-csB { color: rgb(153,153,119); font-style: italic; }
pre.hljl > span.hljl-g { }
pre.hljl > span.hljl-gd { }
pre.hljl > span.hljl-ge { }
pre.hljl > span.hljl-geB { }
pre.hljl > span.hljl-gh { }
pre.hljl > span.hljl-gi { }
pre.hljl > span.hljl-go { }
pre.hljl > span.hljl-gp { }
pre.hljl > span.hljl-gs { }
pre.hljl > span.hljl-gsB { }
pre.hljl > span.hljl-gt { }
</style>



  <style type="text/css">
  @font-face {
  font-style: normal;
  font-weight: 300;
}
@font-face {
  font-style: normal;
  font-weight: 400;
}
@font-face {
  font-style: normal;
  font-weight: 600;
}
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
body {
  margin: 0;
}
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
audio:not([controls]) {
  display: none;
  height: 0;
}
[hidden],
template {
  display: none;
}
a:active,
a:hover {
  outline: 0;
}
abbr[title] {
  border-bottom: 1px dotted;
}
b,
strong {
  font-weight: bold;
}
dfn {
  font-style: italic;
}
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
mark {
  background: #ff0;
  color: #000;
}
small {
  font-size: 80%;
}
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
img {
  border: 0;
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 70%;
}
svg:not(:root) {
  overflow: hidden;
}
figure {
  margin: 1em 40px;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
pre {
  overflow: auto;
}
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
button {
  overflow: visible;
}
button,
select {
  text-transform: none;
}
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
button[disabled],
html input[disabled] {
  cursor: default;
}
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
input {
  line-height: normal;
}
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
textarea {
  overflow: auto;
}
optgroup {
  font-weight: bold;
}
table {
  font-family: monospace, monospace;
  font-size : 0.8em;
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
thead th {
    border-bottom: 1px solid black;
    background-color: white;
}
tr:nth-child(odd){
  background-color: rgb(248,248,248);
}


/*
* Skeleton V2.0.4
* Copyright 2014, Dave Gamache
* www.getskeleton.com
* Free to use under the MIT license.
* http://www.opensource.org/licenses/mit-license.php
* 12/29/2014
*/
.container {
  position: relative;
  width: 100%;
  max-width: 960px;
  margin: 0 auto;
  padding: 0 20px;
  box-sizing: border-box; }
.column,
.columns {
  width: 100%;
  float: left;
  box-sizing: border-box; }
@media (min-width: 400px) {
  .container {
    width: 85%;
    padding: 0; }
}
@media (min-width: 550px) {
  .container {
    width: 80%; }
  .column,
  .columns {
    margin-left: 4%; }
  .column:first-child,
  .columns:first-child {
    margin-left: 0; }

  .one.column,
  .one.columns                    { width: 4.66666666667%; }
  .two.columns                    { width: 13.3333333333%; }
  .three.columns                  { width: 22%;            }
  .four.columns                   { width: 30.6666666667%; }
  .five.columns                   { width: 39.3333333333%; }
  .six.columns                    { width: 48%;            }
  .seven.columns                  { width: 56.6666666667%; }
  .eight.columns                  { width: 65.3333333333%; }
  .nine.columns                   { width: 74.0%;          }
  .ten.columns                    { width: 82.6666666667%; }
  .eleven.columns                 { width: 91.3333333333%; }
  .twelve.columns                 { width: 100%; margin-left: 0; }

  .one-third.column               { width: 30.6666666667%; }
  .two-thirds.column              { width: 65.3333333333%; }

  .one-half.column                { width: 48%; }

  /* Offsets */
  .offset-by-one.column,
  .offset-by-one.columns          { margin-left: 8.66666666667%; }
  .offset-by-two.column,
  .offset-by-two.columns          { margin-left: 17.3333333333%; }
  .offset-by-three.column,
  .offset-by-three.columns        { margin-left: 26%;            }
  .offset-by-four.column,
  .offset-by-four.columns         { margin-left: 34.6666666667%; }
  .offset-by-five.column,
  .offset-by-five.columns         { margin-left: 43.3333333333%; }
  .offset-by-six.column,
  .offset-by-six.columns          { margin-left: 52%;            }
  .offset-by-seven.column,
  .offset-by-seven.columns        { margin-left: 60.6666666667%; }
  .offset-by-eight.column,
  .offset-by-eight.columns        { margin-left: 69.3333333333%; }
  .offset-by-nine.column,
  .offset-by-nine.columns         { margin-left: 78.0%;          }
  .offset-by-ten.column,
  .offset-by-ten.columns          { margin-left: 86.6666666667%; }
  .offset-by-eleven.column,
  .offset-by-eleven.columns       { margin-left: 95.3333333333%; }

  .offset-by-one-third.column,
  .offset-by-one-third.columns    { margin-left: 34.6666666667%; }
  .offset-by-two-thirds.column,
  .offset-by-two-thirds.columns   { margin-left: 69.3333333333%; }

  .offset-by-one-half.column,
  .offset-by-one-half.columns     { margin-left: 52%; }

}
html {
  font-size: 62.5%; }
body {
  font-size: 1.5em; /* currently ems cause chrome bug misinterpreting rems on body element */
  line-height: 1.6;
  font-weight: 400;
  font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  color: #222; }
h1, h2, h3, h4, h5, h6 {
  margin-top: 0;
  margin-bottom: 2rem;
  font-weight: 300; }
h1 { font-size: 3.6rem; line-height: 1.2;  letter-spacing: -.1rem;}
h2 { font-size: 3.4rem; line-height: 1.25; letter-spacing: -.1rem; }
h3 { font-size: 3.2rem; line-height: 1.3;  letter-spacing: -.1rem; }
h4 { font-size: 2.8rem; line-height: 1.35; letter-spacing: -.08rem; }
h5 { font-size: 2.4rem; line-height: 1.5;  letter-spacing: -.05rem; }
h6 { font-size: 1.5rem; line-height: 1.6;  letter-spacing: 0; }

p {
  margin-top: 0; }
a {
  color: #1EAEDB; }
a:hover {
  color: #0FA0CE; }
.button,
button,
input[type="submit"],
input[type="reset"],
input[type="button"] {
  display: inline-block;
  height: 38px;
  padding: 0 30px;
  color: #555;
  text-align: center;
  font-size: 11px;
  font-weight: 600;
  line-height: 38px;
  letter-spacing: .1rem;
  text-transform: uppercase;
  text-decoration: none;
  white-space: nowrap;
  background-color: transparent;
  border-radius: 4px;
  border: 1px solid #bbb;
  cursor: pointer;
  box-sizing: border-box; }
.button:hover,
button:hover,
input[type="submit"]:hover,
input[type="reset"]:hover,
input[type="button"]:hover,
.button:focus,
button:focus,
input[type="submit"]:focus,
input[type="reset"]:focus,
input[type="button"]:focus {
  color: #333;
  border-color: #888;
  outline: 0; }
.button.button-primary,
button.button-primary,
input[type="submit"].button-primary,
input[type="reset"].button-primary,
input[type="button"].button-primary {
  color: #FFF;
  background-color: #33C3F0;
  border-color: #33C3F0; }
.button.button-primary:hover,
button.button-primary:hover,
input[type="submit"].button-primary:hover,
input[type="reset"].button-primary:hover,
input[type="button"].button-primary:hover,
.button.button-primary:focus,
button.button-primary:focus,
input[type="submit"].button-primary:focus,
input[type="reset"].button-primary:focus,
input[type="button"].button-primary:focus {
  color: #FFF;
  background-color: #1EAEDB;
  border-color: #1EAEDB; }
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea,
select {
  height: 38px;
  padding: 6px 10px; /* The 6px vertically centers text on FF, ignored by Webkit */
  background-color: #fff;
  border: 1px solid #D1D1D1;
  border-radius: 4px;
  box-shadow: none;
  box-sizing: border-box; }
/* Removes awkward default styles on some inputs for iOS */
input[type="email"],
input[type="number"],
input[type="search"],
input[type="text"],
input[type="tel"],
input[type="url"],
input[type="password"],
textarea {
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none; }
textarea {
  min-height: 65px;
  padding-top: 6px;
  padding-bottom: 6px; }
input[type="email"]:focus,
input[type="number"]:focus,
input[type="search"]:focus,
input[type="text"]:focus,
input[type="tel"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
textarea:focus,
select:focus {
  border: 1px solid #33C3F0;
  outline: 0; }
label,
legend {
  display: block;
  margin-bottom: .5rem;
  font-weight: 600; }
fieldset {
  padding: 0;
  border-width: 0; }
input[type="checkbox"],
input[type="radio"] {
  display: inline; }
label > .label-body {
  display: inline-block;
  margin-left: .5rem;
  font-weight: normal; }
ul {
  list-style: circle; }
ol {
  list-style: decimal; }
ul ul,
ul ol,
ol ol,
ol ul {
  margin: 1.5rem 0 1.5rem 3rem;
  font-size: 90%; }
li > p {margin : 0;}
th,
td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #E1E1E1; }
th:first-child,
td:first-child {
  padding-left: 0; }
th:last-child,
td:last-child {
  padding-right: 0; }
button,
.button {
  margin-bottom: 1rem; }
input,
textarea,
select,
fieldset {
  margin-bottom: 1.5rem; }
pre,
blockquote,
dl,
figure,
table,
p,
ul,
ol,
form {
  margin-bottom: 1.0rem; }
.u-full-width {
  width: 100%;
  box-sizing: border-box; }
.u-max-full-width {
  max-width: 100%;
  box-sizing: border-box; }
.u-pull-right {
  float: right; }
.u-pull-left {
  float: left; }
hr {
  margin-top: 3rem;
  margin-bottom: 3.5rem;
  border-width: 0;
  border-top: 1px solid #E1E1E1; }
.container:after,
.row:after,
.u-cf {
  content: "";
  display: table;
  clear: both; }

pre {
  display: block;
  padding: 9.5px;
  margin: 0 0 10px;
  font-size: 13px;
  line-height: 1.42857143;
  word-break: break-all;
  word-wrap: break-word;
  border: 1px solid #ccc;
  border-radius: 4px;
}

pre.hljl {
  margin: 0 0 10px;
  display: block;
  background: #f5f5f5;
  border-radius: 4px;
  padding : 5px;
}

pre.output {
  background: #ffffff;
}

pre.code {
  background: #ffffff;
}

pre.julia-error {
  color : red
}

code,
kbd,
pre,
samp {
  font-family: Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size: 13px;
}


@media (min-width: 400px) {}
@media (min-width: 550px) {}
@media (min-width: 750px) {}
@media (min-width: 1000px) {}
@media (min-width: 1200px) {}

h1.title {margin-top : 20px}
img {max-width : 100%}
div.title {text-align: center;}

  </style>
</HEAD>

<BODY>
  <div class ="container">
    <div class = "row">
      <div class = "col-md-12 twelve columns">
        <div class="title">
          <h1 class="title">MiniTuring</h1>
          
          
        </div>

        <p>In this session, we will develop a very simple probabilistic programming language. The implementation is similar to that of <a href="https://turing.ml/dev/">Turing.jl&#39;s</a>. This is intentional, as we want to demonstrate some key ideas from Turing&#39;s internal implementation.</p>
<p>To make things easy to understand and to implement. We will restrict our language to a very simple subset of the language that Turing actually supports. Defining an accurate syntax description is not our goal here, instead, we will give a simple example, and all program that &quot;looks like&quot; this should work.</p>
<p>For a model defined by the following mathematical form. &#40;Consider <code>x</code> is data, or observed variable in this example.&#41;</p>
<p class="math">\[
\begin{align}
a &\sim Normal(0.5, 1) \\
b &\sim Normal(a, 2) \\
x &\sim Normal(b, 0.5)
\end{align}
\]</p>
<p>We will have the following model definition in our small language.</p>


<pre class='hljl'>
<span class='hljl-nd'>@mini_model</span><span class='hljl-t'> </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>m</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>x</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>


<p>Specifically,</p>
<ul>
<li><p>All observed variables should be arguments of the program.</p>
</li>
<li><p>No control flow is permitted in the model definition.</p>
</li>
<li><p>All variables should be scalars.</p>
</li>
<li><p>No function return.</p>
</li>
</ul>


<pre class='hljl'>
<span class='hljl-cs'># First, we import some needed packages</span><span class='hljl-t'>
</span><span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>MacroTools</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Distributions</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>Random</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>MCMCChains</span>
</pre>



<p>Before getting to the actually compiler, let&#39;s first build the data structure for program trace. A program trace for a probabilistic programming language need to at least record the values of stochastic variables and &#40;log&#41;probability of the corresponding stochastic variables scored by the prior distributions.</p>
<blockquote>
<p><strong>Julia Sidebar</strong> Julia&#39;s high-performance is relied upon its multiple-dispatched based compilation scheme. In so many words, Julia compiler will produce a compiled version of the program customized for some specific types. Thus, in the idea case, it should have very similar performance as a pre-compiled C program. The implication of this is that although typing is not necessary for correct program execution, performance will heavily rely on programmer providing correct and coherent type information.</p>
</blockquote>


<pre class='hljl'>
<span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>VarInfo</span><span class='hljl-p'>{</span><span class='hljl-n'>V</span><span class='hljl-p'>,</span><span class='hljl-n'>L</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>values</span><span class='hljl-oB'>::</span><span class='hljl-n'>V</span><span class='hljl-t'>
    </span><span class='hljl-n'>logps</span><span class='hljl-oB'>::</span><span class='hljl-n'>L</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>VarInfo</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>VarInfo</span><span class='hljl-p'>(</span><span class='hljl-nf'>Dict</span><span class='hljl-p'>{</span><span class='hljl-n'>Symbol</span><span class='hljl-p'>,</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}(),</span><span class='hljl-t'> </span><span class='hljl-nf'>Dict</span><span class='hljl-p'>{</span><span class='hljl-n'>Symbol</span><span class='hljl-p'>,</span><span class='hljl-n'>Float64</span><span class='hljl-p'>}())</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-n'>Base</span><span class='hljl-oB'>.</span><span class='hljl-nf'>setindex!</span><span class='hljl-p'>(</span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>::</span><span class='hljl-n'>VarInfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>value</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>logp</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>var_id</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>value</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>.</span><span class='hljl-n'>logps</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>logp</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>Now, let&#39;s define a <code>context</code> that does something very simple: if a stochastic variable is observed, we compute its log probability; or, if it is assumed&#40;sampled&#41;, then we sample from prior and also computes its log probability. <code>context</code> is an Turing internal implementation mechanism. Because different inference algorithms may have slightly different actions to do with stochastic variables, we want a good abstraction and interface to implement these. The name <code>context</code> comes from the &quot;contextual dispatching&quot; idea of <a href="https://github.com/JuliaLabs/Cassette.jl">Cassette.jl</a>. Every <code>context</code>s is defined to be a type in Julia, and the <code>observe</code> and <code>assume</code> functions will take a <code>AbstractContext</code> type as their first arguments. Then, at runtime, the Julia multiple-dispatch system will dispatch corresponding functions according to the type that is a specific <code>context</code>.</p>
<p><strong>Note:</strong> <em>Although the context system in this tutorial is inspired by Turing&#39;s, Turing&#39;s context system is battle-tested and much more complicated. Thus, readers are advised to refer to Turing&#39;s documentations and code if knowledge of Turing&#39;s context system is required. Also, it should be pointed out that the context system design in Turing is not in its definitive form as of the current version at the time of this notebook is written.</em></p>


<pre class='hljl'>
<span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>{</span><span class='hljl-n'>R</span><span class='hljl-oB'>&lt;:</span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractRNG</span><span class='hljl-p'>,</span><span class='hljl-n'>S</span><span class='hljl-oB'>&lt;:</span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractSampler</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>rng</span><span class='hljl-oB'>::</span><span class='hljl-n'>R</span><span class='hljl-t'>
    </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>S</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-n'>DummySampler</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractSampler</span><span class='hljl-t'> </span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>(</span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>default_rng</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-nf'>DummySampler</span><span class='hljl-p'>())</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>observe</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-n'>SamplingContext</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_id</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_value</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>logp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Distributions</span><span class='hljl-oB'>.</span><span class='hljl-nf'>loglikelihood</span><span class='hljl-p'>(</span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_value</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>var_value</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>logp</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>var_value</span><span class='hljl-t'> </span><span class='hljl-cs'># return value not used, only for coherent behavior as `assume`</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>assume</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-n'>SamplingContext</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>DummySampler</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_id</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>sample</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>rng</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dist</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>logp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Distributions</span><span class='hljl-oB'>.</span><span class='hljl-nf'>loglikelihood</span><span class='hljl-p'>(</span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sample</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>sample</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>logp</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>sample</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>Then, we&#39;ll encounter our first nontrivial piece of Julia code, that is the compiler. In one sentence, the compiler will replace every tilde notation with a call to <code>observe</code> or <code>assume</code> function defined in the <code>context</code> code block.</p>
<blockquote>
<p><strong>Julia Sidebar</strong> I am afraid there is not easy way to explain what happens here. So I am going leave some references, and once the reader go though the referenced material, the following block should not be too difficult to understand.</p>
<ul>
<li><p><a href="https://docs.julialang.org/en/v1/manual/metaprogramming/">Julia Metaprogramming</a></p>
</li>
<li><p><a href="https://fluxml.ai/MacroTools.jl/dev/pattern-matching/">MacroTools</a></p>
</li>
<li><p><a href="https://turing.ml/dev/docs/for-developers/compiler">Turing Compiler Design</a> &#40;The implementation here is heavily simplified compared to Turing&#39;s compiler.&#41;</p>
</li>
</ul>
</blockquote>


<pre class='hljl'>
<span class='hljl-k'>macro</span><span class='hljl-t'> </span><span class='hljl-nf'>mini_model</span><span class='hljl-p'>(</span><span class='hljl-n'>expr</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>esc</span><span class='hljl-p'>(</span><span class='hljl-nf'>mini_model</span><span class='hljl-p'>(</span><span class='hljl-n'>expr</span><span class='hljl-p'>))</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>mini_model</span><span class='hljl-p'>(</span><span class='hljl-n'>expr</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>def</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>MacroTools</span><span class='hljl-oB'>.</span><span class='hljl-nf'>splitdef</span><span class='hljl-p'>(</span><span class='hljl-n'>expr</span><span class='hljl-p'>)</span><span class='hljl-t'>

    </span><span class='hljl-cs'># `MacroTools.postwalk` is a utility function for traverse AST in post-order</span><span class='hljl-t'>
    </span><span class='hljl-n'>def</span><span class='hljl-p'>[</span><span class='hljl-sc'>:body</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>MacroTools</span><span class='hljl-oB'>.</span><span class='hljl-nf'>postwalk</span><span class='hljl-p'>(</span><span class='hljl-n'>def</span><span class='hljl-p'>[</span><span class='hljl-sc'>:body</span><span class='hljl-p'>])</span><span class='hljl-t'> </span><span class='hljl-k'>do</span><span class='hljl-t'> </span><span class='hljl-n'>sub_expr</span><span class='hljl-t'>
        </span><span class='hljl-cs'># `MacroTools.@capture` provide a utility function for pattern matching</span><span class='hljl-t'>
        </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-n'>MacroTools</span><span class='hljl-oB'>.</span><span class='hljl-nd'>@capture</span><span class='hljl-p'>(</span><span class='hljl-n'>sub_expr</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-n'>dist_</span><span class='hljl-p'>)</span><span class='hljl-t'>
            </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-n'>var</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>def</span><span class='hljl-p'>[</span><span class='hljl-sc'>:args</span><span class='hljl-p'>]</span><span class='hljl-t'>
                </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-k'>quote</span><span class='hljl-t'>
                    </span><span class='hljl-oB'>$</span><span class='hljl-p'>(</span><span class='hljl-n'>observe</span><span class='hljl-p'>)(</span><span class='hljl-t'>
                        </span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'>
                        </span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>sampler</span><span class='hljl-p'>,</span><span class='hljl-t'>
                        </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>,</span><span class='hljl-t'>
                        </span><span class='hljl-oB'>$</span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'>
                        </span><span class='hljl-oB'>$</span><span class='hljl-p'>(</span><span class='hljl-n'>Meta</span><span class='hljl-oB'>.</span><span class='hljl-nf'>quot</span><span class='hljl-p'>(</span><span class='hljl-n'>var</span><span class='hljl-p'>)),</span><span class='hljl-t'>
                        </span><span class='hljl-oB'>$</span><span class='hljl-n'>var</span><span class='hljl-p'>,</span><span class='hljl-t'>
                    </span><span class='hljl-p'>)</span><span class='hljl-t'>
                </span><span class='hljl-k'>end</span><span class='hljl-t'>
            </span><span class='hljl-k'>else</span><span class='hljl-t'>
                </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-k'>quote</span><span class='hljl-t'>
                    </span><span class='hljl-oB'>$</span><span class='hljl-n'>var</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-oB'>$</span><span class='hljl-p'>(</span><span class='hljl-n'>assume</span><span class='hljl-p'>)(</span><span class='hljl-t'>
                        </span><span class='hljl-n'>context</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>sampler</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>$</span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>$</span><span class='hljl-p'>(</span><span class='hljl-n'>Meta</span><span class='hljl-oB'>.</span><span class='hljl-nf'>quot</span><span class='hljl-p'>(</span><span class='hljl-n'>var</span><span class='hljl-p'>))</span><span class='hljl-t'>
                    </span><span class='hljl-p'>)</span><span class='hljl-t'>
                </span><span class='hljl-k'>end</span><span class='hljl-t'>
            </span><span class='hljl-k'>end</span><span class='hljl-t'>
        </span><span class='hljl-k'>else</span><span class='hljl-t'>
            </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>sub_expr</span><span class='hljl-t'>
        </span><span class='hljl-k'>end</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>

    </span><span class='hljl-n'>def</span><span class='hljl-p'>[</span><span class='hljl-sc'>:args</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>vcat</span><span class='hljl-p'>([</span><span class='hljl-t'>
        </span><span class='hljl-cs'># Insert extra arguments</span><span class='hljl-t'>
        </span><span class='hljl-oB'>:</span><span class='hljl-p'>(</span><span class='hljl-n'>varinfo</span><span class='hljl-p'>),</span><span class='hljl-t'>
        </span><span class='hljl-oB'>:</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-p'>),</span><span class='hljl-t'>
    </span><span class='hljl-p'>],</span><span class='hljl-t'> </span><span class='hljl-n'>def</span><span class='hljl-p'>[</span><span class='hljl-sc'>:args</span><span class='hljl-p'>])</span><span class='hljl-t'>

    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>MacroTools</span><span class='hljl-oB'>.</span><span class='hljl-nf'>combinedef</span><span class='hljl-p'>(</span><span class='hljl-n'>def</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>Next, let&#39;s define a <code>MiniModel</code> struct. In the actual implementation of the compiler in Turing, the model construction is done as the final step of the compilation. But for the sake of simplicity, we will construct the model manually. This also requires us to keep a field for the actually data in the <code>MiniModel</code> struct.</p>


<pre class='hljl'>
<span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>MiniModel</span><span class='hljl-p'>{</span><span class='hljl-n'>F</span><span class='hljl-p'>,</span><span class='hljl-n'>D</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractModel</span><span class='hljl-t'>
    </span><span class='hljl-n'>f</span><span class='hljl-oB'>::</span><span class='hljl-n'>F</span><span class='hljl-t'>
    </span><span class='hljl-n'>data</span><span class='hljl-oB'>::</span><span class='hljl-n'>D</span><span class='hljl-t'> </span><span class='hljl-cs'># a NamedTuple of all the data</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span>
</pre>



<p>To illustrate how inference work for our mini language. We will implement an extremely simplistic Random-Walk Metropolis-Hastings sampler.</p>
<blockquote>
<p><strong>Julia Sidebar</strong> We used the Julia package <a href="https://github.com/TuringLang/AbstractMCMC.jl">AbstractMCMC.jl</a> here. For the interface design, we refer the reader to the <a href="https://beta.turing.ml/AbstractMCMC.jl/dev/">documentation</a>.</p>
</blockquote>
<p>In simple words, we need to implement a sub-type of <code>AbstractModel</code>, which we did in the code block above; a sub-type of <code>AbstractSampler</code>, which we&#39;ll do in the next code block; and <code>step</code> functions, following the sampler definition.</p>


<pre class='hljl'>
<span class='hljl-cs'># Just a Normal distribution as proposal in this simple case</span><span class='hljl-t'>
</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>MHSampler</span><span class='hljl-p'>{</span><span class='hljl-n'>P</span><span class='hljl-oB'>&lt;:</span><span class='hljl-n'>Normal</span><span class='hljl-p'>}</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;:</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractSampler</span><span class='hljl-t'>
    </span><span class='hljl-n'>proposal</span><span class='hljl-oB'>::</span><span class='hljl-n'>P</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-k'>struct</span><span class='hljl-t'> </span><span class='hljl-nf'>Transition</span><span class='hljl-p'>{</span><span class='hljl-n'>V</span><span class='hljl-p'>}</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>::</span><span class='hljl-n'>V</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>(</span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>MHSampler</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>(</span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-nf'>default_rng</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Main.##WeaveSandBox#275.SamplingContext
</pre>


<p>We hard-coded the proposal step as part of a <code>context</code> implementation. In Turing, to accommodate more use-cases, the <code>proposal</code> function is abstracted out.</p>


<pre class='hljl'>
<span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>assume</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>::</span><span class='hljl-n'>SamplingContext</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>MHSampler</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>var_id</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>old_value</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-cs'># propose a random-walk step, i.e, add the current value to a random </span><span class='hljl-t'>
    </span><span class='hljl-cs'># value sampled from a Normal distribution centered at 0</span><span class='hljl-t'>
    </span><span class='hljl-n'>value</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>old_value</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'> </span><span class='hljl-nf'>rand</span><span class='hljl-p'>(</span><span class='hljl-n'>context</span><span class='hljl-oB'>.</span><span class='hljl-n'>rng</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>.</span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>logp</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>Distributions</span><span class='hljl-oB'>.</span><span class='hljl-nf'>loglikelihood</span><span class='hljl-p'>(</span><span class='hljl-n'>dist</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>value</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>varinfo</span><span class='hljl-p'>[</span><span class='hljl-n'>var_id</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>value</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>logp</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>value</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>We need to define two <code>step</code> functions, one for the first step and the other for the following steps. The two functions are identified with different arguments they take.</p>


<pre class='hljl'>
<span class='hljl-cs'># The fist step</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-nf'>step</span><span class='hljl-p'>(</span><span class='hljl-t'>
    </span><span class='hljl-n'>rng</span><span class='hljl-oB'>::</span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractRNG</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>model</span><span class='hljl-oB'>::</span><span class='hljl-n'>MiniModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>MHSampler</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>kwargs</span><span class='hljl-oB'>...</span><span class='hljl-t'>
</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>vi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>VarInfo</span><span class='hljl-p'>()</span><span class='hljl-t'>
    </span><span class='hljl-n'>ctx</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>()</span><span class='hljl-t'> </span><span class='hljl-cs'># context with DUmmySampler</span><span class='hljl-t'>
    </span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-nf'>f</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ctx</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-oB'>...</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>Transition</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>vi</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-cs'># Defining functions to compute values to determine if accept the proposal</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>condition_logprob</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>condition_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>args</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-t'>
        </span><span class='hljl-n'>Distributions</span><span class='hljl-oB'>.</span><span class='hljl-nf'>loglikelihood</span><span class='hljl-p'>(</span><span class='hljl-n'>proposal</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>vi</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-p'>[</span><span class='hljl-n'>key</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-n'>condition_vi</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-p'>[</span><span class='hljl-n'>key</span><span class='hljl-p'>])</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'>
        </span><span class='hljl-n'>key</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-nf'>keys</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-oB'>!</span><span class='hljl-p'>(</span><span class='hljl-n'>key</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>args</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-nf'>log_joint</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>sum</span><span class='hljl-p'>(</span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-oB'>.</span><span class='hljl-n'>logps</span><span class='hljl-p'>))</span><span class='hljl-t'>

</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>logα</span><span class='hljl-p'>(</span><span class='hljl-n'>old_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>new_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>args</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>log_joint</span><span class='hljl-p'>(</span><span class='hljl-n'>new_vi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'> </span><span class='hljl-nf'>log_joint</span><span class='hljl-p'>(</span><span class='hljl-n'>old_vi</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>+</span><span class='hljl-t'>
           </span><span class='hljl-nf'>condition_logprob</span><span class='hljl-p'>(</span><span class='hljl-n'>old_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>new_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>args</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-t'>
           </span><span class='hljl-nf'>condition_logprob</span><span class='hljl-p'>(</span><span class='hljl-n'>new_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>old_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>args</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-cs'># The following steps</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-nf'>step</span><span class='hljl-p'>(</span><span class='hljl-t'>
    </span><span class='hljl-n'>rng</span><span class='hljl-oB'>::</span><span class='hljl-n'>Random</span><span class='hljl-oB'>.</span><span class='hljl-n'>AbstractRNG</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>model</span><span class='hljl-oB'>::</span><span class='hljl-n'>MiniModel</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>sampler</span><span class='hljl-oB'>::</span><span class='hljl-n'>MHSampler</span><span class='hljl-p'>,</span><span class='hljl-t'>
    </span><span class='hljl-n'>prev_state</span><span class='hljl-oB'>::</span><span class='hljl-n'>VarInfo</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-cs'># is just the old vi</span><span class='hljl-t'>
    </span><span class='hljl-n'>kargs</span><span class='hljl-oB'>...</span><span class='hljl-p'>,</span><span class='hljl-t'>
</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>vi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-n'>prev_state</span><span class='hljl-t'>
    </span><span class='hljl-n'>new_vi</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>deepcopy</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>ctx</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>SamplingContext</span><span class='hljl-p'>(</span><span class='hljl-n'>sampler</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-nf'>f</span><span class='hljl-p'>(</span><span class='hljl-n'>new_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>ctx</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>values</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-p'>)</span><span class='hljl-oB'>...</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>log_α</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>logα</span><span class='hljl-p'>(</span><span class='hljl-n'>vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>new_vi</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>keys</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>ctx</span><span class='hljl-oB'>.</span><span class='hljl-n'>sampler</span><span class='hljl-oB'>.</span><span class='hljl-n'>proposal</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-oB'>-</span><span class='hljl-nf'>randexp</span><span class='hljl-p'>(</span><span class='hljl-n'>rng</span><span class='hljl-p'>)</span><span class='hljl-t'> </span><span class='hljl-oB'>&lt;</span><span class='hljl-t'> </span><span class='hljl-n'>log_α</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>Transition</span><span class='hljl-p'>(</span><span class='hljl-n'>new_vi</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>new_vi</span><span class='hljl-t'>
    </span><span class='hljl-k'>else</span><span class='hljl-t'>
        </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-nf'>Transition</span><span class='hljl-p'>(</span><span class='hljl-n'>prev_state</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-n'>prev_state</span><span class='hljl-t'>
    </span><span class='hljl-k'>end</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-t'>

</span><span class='hljl-cs'># Create Chains object at the end of the sampling process</span><span class='hljl-t'>
</span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-n'>AbstractMCMC</span><span class='hljl-oB'>.</span><span class='hljl-nf'>bundle_samples</span><span class='hljl-p'>(</span><span class='hljl-t'>
    </span><span class='hljl-n'>samples</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>model</span><span class='hljl-oB'>::</span><span class='hljl-n'>MiniModel</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>::</span><span class='hljl-n'>MHSampler</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>::</span><span class='hljl-n'>Any</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-oB'>::</span><span class='hljl-n'>Type</span><span class='hljl-p'>;</span><span class='hljl-t'> </span><span class='hljl-n'>kargs</span><span class='hljl-oB'>...</span><span class='hljl-t'>
</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'># We get a vector of `Transition`s</span><span class='hljl-t'>
    </span><span class='hljl-n'>values</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>sample</span><span class='hljl-oB'>.</span><span class='hljl-n'>varinfo</span><span class='hljl-oB'>.</span><span class='hljl-n'>values</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>sample</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>samples</span><span class='hljl-p'>]</span><span class='hljl-t'>
    </span><span class='hljl-n'>params</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>key</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>key</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>Base</span><span class='hljl-oB'>.</span><span class='hljl-nf'>keys</span><span class='hljl-p'>(</span><span class='hljl-n'>values</span><span class='hljl-p'>[</span><span class='hljl-ni'>1</span><span class='hljl-p'>])</span><span class='hljl-t'> </span><span class='hljl-k'>if</span><span class='hljl-t'> </span><span class='hljl-n'>key</span><span class='hljl-t'> </span><span class='hljl-oB'>∉</span><span class='hljl-t'> </span><span class='hljl-nf'>keys</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-oB'>.</span><span class='hljl-n'>data</span><span class='hljl-p'>)]</span><span class='hljl-t'>
    </span><span class='hljl-n'>vals</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>reduce</span><span class='hljl-p'>(</span><span class='hljl-n'>hcat</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-p'>[</span><span class='hljl-n'>value</span><span class='hljl-p'>[</span><span class='hljl-n'>p</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>value</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>values</span><span class='hljl-p'>]</span><span class='hljl-t'> </span><span class='hljl-k'>for</span><span class='hljl-t'> </span><span class='hljl-n'>p</span><span class='hljl-t'> </span><span class='hljl-kp'>in</span><span class='hljl-t'> </span><span class='hljl-n'>params</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-cs'># Composing the `Chains` data-structure, of which analyzing infrastructure is provided</span><span class='hljl-t'>
    </span><span class='hljl-n'>chains</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>Chains</span><span class='hljl-p'>(</span><span class='hljl-n'>vals</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-n'>params</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>chains</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>Now, let&#39;s see how our mini probabilistic programming language works. Define the probabilistic model.</p>


<pre class='hljl'>
<span class='hljl-nd'>@mini_model</span><span class='hljl-t'> </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>m</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>x</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>



<p>Given data <code>x &#61; 3.0</code>.</p>


<pre class='hljl'>
<span class='hljl-cs'># Manually defining the model.</span><span class='hljl-t'>
</span><span class='hljl-n'>model</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>MiniModel</span><span class='hljl-p'>(</span><span class='hljl-n'>m</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-oB'>=</span><span class='hljl-nfB'>3.0</span><span class='hljl-p'>,))</span><span class='hljl-t'>

</span><span class='hljl-cs'># `sample` function is implemented as part of `AbstractMCMC.jl`</span><span class='hljl-t'>
</span><span class='hljl-n'>samples</span><span class='hljl-t'> </span><span class='hljl-oB'>=</span><span class='hljl-t'> </span><span class='hljl-nf'>sample</span><span class='hljl-p'>(</span><span class='hljl-n'>model</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nf'>MHSampler</span><span class='hljl-p'>(</span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-ni'>0</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-p'>)),</span><span class='hljl-t'> </span><span class='hljl-ni'>1000000</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Chains MCMC chain &#40;1000000×2×1 Array&#123;Float64, 3&#125;&#41;:

Iterations        &#61; 1:1:1000000
Number of chains  &#61; 1
Samples per chain &#61; 1000000
parameters        &#61; a, b

Summary Statistics
  parameters      mean       std   naive_se      mcse           ess      rh
at
      Symbol   Float64   Float64    Float64   Float64       Float64   Float
64

           a    0.9696    0.8980     0.0009    0.0033    79952.8364    1.00
00
           b    2.8811    0.4867     0.0005    0.0012   172639.3150    1.00
00

Quantiles
  parameters      2.5&#37;     25.0&#37;     50.0&#37;     75.0&#37;     97.5&#37;
      Symbol   Float64   Float64   Float64   Float64   Float64

           a   -0.8031    0.3690    0.9706    1.5770    2.7231
           b    1.9273    2.5513    2.8827    3.2114    3.8296
</pre>


<p>Now, let&#39;s see what Turing gives us.</p>


<pre class='hljl'>
<span class='hljl-k'>using</span><span class='hljl-t'> </span><span class='hljl-n'>Turing</span><span class='hljl-t'>

</span><span class='hljl-nd'>@model</span><span class='hljl-t'> </span><span class='hljl-k'>function</span><span class='hljl-t'> </span><span class='hljl-nf'>turing_m</span><span class='hljl-p'>(</span><span class='hljl-n'>x</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>a</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>1</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>b</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>a</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-ni'>2</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-n'>x</span><span class='hljl-t'> </span><span class='hljl-oB'>~</span><span class='hljl-t'> </span><span class='hljl-nf'>Normal</span><span class='hljl-p'>(</span><span class='hljl-n'>b</span><span class='hljl-p'>,</span><span class='hljl-t'> </span><span class='hljl-nfB'>0.5</span><span class='hljl-p'>)</span><span class='hljl-t'>
    </span><span class='hljl-k'>return</span><span class='hljl-t'> </span><span class='hljl-n'>nothing</span><span class='hljl-t'>
</span><span class='hljl-k'>end</span><span class='hljl-p'>;</span>
</pre>




<pre class='hljl'>
<span class='hljl-nf'>sample</span><span class='hljl-p'>(</span><span class='hljl-nf'>turing_m</span><span class='hljl-p'>(</span><span class='hljl-nfB'>3.0</span><span class='hljl-p'>),</span><span class='hljl-t'> </span><span class='hljl-nf'>MH</span><span class='hljl-p'>(),</span><span class='hljl-t'> </span><span class='hljl-ni'>1000000</span><span class='hljl-p'>)</span>
</pre>


<pre class="output">
Chains MCMC chain &#40;1000000×3×1 Array&#123;Float64, 3&#125;&#41;:

Iterations        &#61; 1:1:1000000
Number of chains  &#61; 1
Samples per chain &#61; 1000000
Wall duration     &#61; 14.54 seconds
Compute duration  &#61; 14.54 seconds
parameters        &#61; a, b
internals         &#61; lp

Summary Statistics
  parameters      mean       std   naive_se      mcse           ess      rh
at  ⋯
      Symbol   Float64   Float64    Float64   Float64       Float64   Float
64  ⋯

           a    0.9741    0.9020     0.0009    0.0028   101659.9088    1.00
00  ⋯
           b    2.8805    0.4881     0.0005    0.0012   167725.6265    1.00
00  ⋯
                                                                1 column om
itted

Quantiles
  parameters      2.5&#37;     25.0&#37;     50.0&#37;     75.0&#37;     97.5&#37;
      Symbol   Float64   Float64   Float64   Float64   Float64

           a   -0.7963    0.3667    0.9708    1.5789    2.7500
           b    1.9257    2.5501    2.8798    3.2108    3.8374
</pre>


<p>As you can see, we got the same results as Turing.</p>


        <HR/>
        <div class="footer">
          <p>
            Published from <a href="14_minituring.jmd">14_minituring.jmd</a>
            using <a href="http://github.com/JunoLab/Weave.jl">Weave.jl</a> v0.10.10 on 2022-08-19.
          </p>
        </div>
      </div>
    </div>
  </div>
</BODY>

</HTML>
